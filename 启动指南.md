# 项目启动指南

## 前置要求

1. **Python 3.7+**
2. **PostgreSQL 数据库**（需要先安装并启动）
3. **pip**（Python 包管理器）

## 启动步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置数据库

#### 2.1 创建 PostgreSQL 数据库

使用 PostgreSQL 客户端（如 pgAdmin 或命令行）创建数据库：

```sql
CREATE DATABASE chunmpre_db;
```

或者使用命令行：

```bash
# Windows (如果 PostgreSQL 在 PATH 中)
createdb -U postgres chunmpre_db

# Linux/Mac
sudo -u postgres createdb chunmpre_db
```

#### 2.2 配置数据库连接（可选）

如果需要自定义数据库连接，可以创建 `.env` 文件：

```env
# .env 文件
DATABASE_URL=postgresql://用户名:密码@localhost:5432/chunmpre_db
SECRET_KEY=your-secret-key-here
FLASK_CONFIG=development
```

**注意**：如果不创建 `.env` 文件，将使用默认配置：
- 数据库：`postgresql://admin:password@localhost/chunmpre_db`
- 密钥：`hard-to-guess-string`

### 3. 初始化数据库

```bash
# 方式1：使用 Flask CLI 命令
flask init-db

# 方式2：如果 flask 命令不可用，使用 Python
python -m flask init-db
```

这个命令会：
- 创建所有数据库表
- 创建默认分类（光学测量仪器、坐标测量仪等）

### 4. 创建管理员账户

```bash
flask create-admin
```

或者：

```bash
python -m flask create-admin
```

默认管理员账户：
- 用户名：`admin`
- 密码：`admin123`

**⚠️ 重要**：首次登录后请立即修改密码！

### 5. （可选）导入示例数据

如果需要导入示例产品数据：

```bash
flask import-sample-data
```

### 6. 启动应用

#### 方式1：直接运行 app.py（推荐用于开发）

```bash
python app.py
```

#### 方式2：使用 Flask CLI

```bash
# 设置 Flask 应用入口
set FLASK_APP=app.py  # Windows
export FLASK_APP=app.py  # Linux/Mac

# 启动应用
flask run

# 或者指定主机和端口
flask run --host=0.0.0.0 --port=5000
```

### 7. 访问应用

启动成功后，在浏览器中访问：

- **前台网站**：http://localhost:5000
- **后台管理**：http://localhost:5000/admin/dashboard
- **登录页面**：http://localhost:5000/auth/login

## 常见问题

### 问题1：数据库连接失败

**错误信息**：`psycopg2.OperationalError: could not connect to server`

**解决方法**：
1. 确保 PostgreSQL 服务已启动
2. 检查数据库连接信息是否正确
3. 确认数据库 `chunmpre_db` 已创建
4. 检查用户名和密码是否正确

### 问题2：flask 命令不可用

**解决方法**：
```bash
# 使用 python -m flask 代替 flask
python -m flask init-db
python -m flask create-admin
python -m flask run
```

### 问题3：端口被占用

**错误信息**：`Address already in use`

**解决方法**：
```bash
# 使用其他端口
flask run --port=5001
# 或修改 app.py 中的端口号
```

### 问题4：模块导入错误

**解决方法**：
```bash
# 确保在项目根目录下运行
cd E:\Pycharm\work\chunmpre.cn

# 检查 Python 路径
python -c "import sys; print(sys.path)"
```

## 开发环境配置

### 使用虚拟环境（推荐）

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

## 生产环境部署

生产环境部署时，请：

1. 设置强密码的 `SECRET_KEY`
2. 使用环境变量配置数据库连接
3. 设置 `FLASK_CONFIG=production`
4. 使用 WSGI 服务器（如 Gunicorn）而不是开发服务器
5. 配置反向代理（如 Nginx）

示例 Gunicorn 启动：

```bash
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

## 数据库迁移

如果需要更新数据库结构：

```bash
flask db-migrate
```

**注意**：当前使用的是简单的 `create_all()` 方法。生产环境建议使用 Flask-Migrate 进行更安全的数据库迁移。

## 项目结构说明

```
chunmpre.cn/
├── app/              # 主应用包
│   ├── models.py     # 数据模型
│   ├── routes.py     # 前台路由
│   ├── admin.py      # 后台管理
│   ├── auth.py       # 认证模块
│   └── templates/    # 模板文件
├── app.py            # 应用入口
├── config.py         # 配置文件
└── requirements.txt  # 依赖列表
```

## 技术支持

如有问题，请检查：
1. Python 版本是否符合要求
2. 所有依赖是否已正确安装
3. 数据库服务是否正常运行
4. 端口是否被占用

