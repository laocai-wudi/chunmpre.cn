# 东莞春鸣精密机械有限公司 - 项目总结文档

## 📋 项目概述

这是一个基于 Flask 的精密机械设备管理系统，包含前台展示网站和后台管理系统。系统支持产品管理、分类管理、联系表单管理等功能，采用 PostgreSQL 数据库存储数据，图片以二进制形式存储在数据库中。

### 项目特点

- ✅ **前后台分离**：前台展示网站 + 后台管理系统
- ✅ **响应式设计**：使用 Tailwind CSS，支持移动端和桌面端
- ✅ **数据库存储图片**：所有产品图片存储在 PostgreSQL 数据库中
- ✅ **完整的 CRUD 功能**：产品、分类、联系表单的增删改查
- ✅ **用户认证系统**：基于 Flask-Login 的登录认证
- ✅ **CSRF 保护**：使用 Flask-WTF 提供表单安全保护
- ✅ **分页功能**：产品列表支持分页显示

---

## 📁 项目结构

```
chunmpre.cn/
├── app/                          # 主应用包
│   ├── __init__.py              # 应用初始化，创建 Flask 实例
│   ├── models.py                 # 数据模型（Product, Category, User, ProductImage, Contact）
│   ├── routes.py                 # 前台路由（首页、产品、产品详情、联系我们等）
│   ├── admin.py                  # 后台管理路由（产品管理、分类管理、联系表单管理）
│   ├── auth.py                   # 认证路由（登录、登出）
│   ├── forms.py                  # WTForms 表单定义
│   ├── static/                   # 静态文件目录
│   │   ├── images/              # 图片资源
│   │   └── uploads/             # 上传文件目录（未使用，图片存储在数据库）
│   └── templates/                # 模板文件
│       ├── frontend/            # 前台模板
│       │   ├── base.html        # 前台基础模板
│       │   ├── index.html       # 首页
│       │   ├── products.html   # 产品列表页
│       │   ├── product-detail.html  # 产品详情页
│       │   ├── contact.html     # 联系我们页
│       │   ├── about.html       # 关于我们页（已废弃，重定向到首页）
│       │   ├── 404.html         # 404错误页
│       │   └── 500.html         # 500错误页
│       └── admin/               # 后台模板
│           ├── base.html        # 后台基础模板
│           ├── login.html       # 登录页
│           ├── dashboard.html   # 仪表盘
│           ├── products.html    # 产品管理页
│           ├── add_product.html # 添加产品页
│           ├── edit_product.html # 编辑产品页
│           ├── manage_product_images.html # 产品图库管理页
│           ├── categories.html  # 分类管理页
│           ├── edit_category.html # 编辑分类页
│           ├── contacts.html    # 联系表单列表页
│           └── view_contact.html # 查看联系表单详情页
│
├── app.py                        # 应用入口文件，包含 CLI 命令
├── config.py                     # 配置文件（开发/生产/测试环境）
├── requirements.txt               # Python 依赖包列表
├── migrate_add_product_fields.py # 数据库迁移脚本（添加产品新字段）
├── DATABASE_MIGRATION.md         # 数据库迁移说明文档
├── 启动指南.md                   # 启动指南（旧版，已整合到本文档）
│
├── HTML-code/                    # 参考 HTML 文件（设计参考）
├── chunmpre-admin/               # 参考后台设计文件（设计参考）
├── company-images/               # 公司图片资源
├── instrument-images/           # 仪器图片资源
│
└── venv/                         # Python 虚拟环境（不应提交到版本控制）
```

---

## 🚀 快速启动指南

### 前置要求

1. **Python 3.7+**
2. **PostgreSQL 数据库**（需要先安装并启动）
3. **pip**（Python 包管理器）

### 1. 安装依赖

```bash
# 进入项目目录
cd chunmpre.cn

# 创建虚拟环境（推荐）
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 2. 配置数据库

#### 2.1 创建 PostgreSQL 数据库

```sql
CREATE DATABASE chunmpre_db;
```

或者使用命令行：

```bash
# Windows (如果 PostgreSQL 在 PATH 中)
createdb -U postgres chunmpre_db

# Linux/Mac
sudo -u postgres createdb chunmpre_db
```

#### 2.2 配置数据库连接

编辑 `config.py` 文件，修改数据库连接字符串：

```python
SQLALCHEMY_DATABASE_URI = 'postgresql://用户名:密码@主机:端口/chunmpre_db'
```

或者创建 `.env` 文件（推荐）：

```env
DATABASE_URL=postgresql://postgres:123456@localhost:5432/chunmpre_db
SECRET_KEY=your-secret-key-here
FLASK_CONFIG=development
```

### 3. 初始化数据库

```bash
# 方式1：使用 Flask CLI 命令
flask init-db

# 方式2：如果 flask 命令不可用（推荐）
python -m flask init-db
```

这个命令会：
- 创建所有数据库表
- 创建默认分类（光学测量仪器、坐标测量仪、激光干涉仪、三坐标测量机、影像测量仪）

### 4. 执行数据库迁移（添加新字段）

如果数据库已存在，需要执行迁移脚本添加新字段：

```bash
python migrate_add_product_fields.py
```

这个脚本会添加以下字段到 `products` 表：
- `brand` - 品牌
- `price_min`, `price_max`, `price_note` - 价格相关
- `technical_specs` - 技术规格（JSON）
- `advantages` - 产品优势列表
- `rating`, `review_count` - 评分和评价
- `service_tags` - 服务标签（JSON）
- `tab_contents` - 标签页内容（JSON）

### 5. 创建管理员账户

```bash
flask create-admin
```

或者（推荐）：

```bash
python -m flask create-admin
```

默认管理员账户：
- **用户名**：`admin`
- **密码**：`admin123`

⚠️ **重要**：首次登录后请立即修改密码！

### 6. （可选）导入示例数据

如果需要导入示例产品数据：

```bash
flask import-sample-data
```
python -m flask import-sample-data

### 7. 启动应用
# 启动命令
cd /test/chunmpre.cn && python -m flask run --host=0.0.0.0 --port=5000 

# 停止命令
cd /test/chunmpre.cn && pkill -f "flask run" && sleep 2 && echo "应用已停止"

#### 方式1：直接运行 app.py（推荐用于开发）

```bash
python app.py
```

#### 方式2：使用 Flask CLI

```bash
# 设置 Flask 应用入口
set FLASK_APP=app.py  # Windows
export FLASK_APP=app.py  # Linux/Mac

# 启动应用
flask run

# 或者指定主机和端口
flask run --host=0.0.0.0 --port=5000
```


### 8. 访问应用

启动成功后，在浏览器中访问：

- **前台网站**：http://localhost:5000
- **后台管理**：http://localhost:5000/admin/dashboard
- **登录页面**：http://localhost:5000/auth/login

---

## 🗄️ 数据库设计

### 数据表结构

#### 1. **users** - 用户表
- `id` - 主键
- `username` - 用户名（唯一）
- `email` - 邮箱
- `password_hash` - 密码哈希
- `is_admin` - 是否管理员
- `created_at` - 创建时间

#### 2. **categories** - 分类表
- `id` - 主键
- `name` - 分类名称（唯一）
- `description` - 分类描述
- `created_at` - 创建时间

#### 3. **products** - 产品表
- `id` - 主键
- `name` - 产品名称
- `description` - 产品描述
- `category_id` - 分类ID（外键）
- `main_image` - 主图（二进制）
- `main_image_filename` - 主图文件名
- `main_image_mimetype` - 主图MIME类型
- `price` - 价格
- `stock` - 库存
- `status` - 状态（上架/下架）
- `created_at` - 创建时间
- `updated_at` - 更新时间

**新增字段（通过迁移脚本添加）：**
- `brand` - 品牌
- `price_min`, `price_max`, `price_note` - 价格范围
- `technical_specs` - 技术规格（JSON）
- `advantages` - 产品优势列表
- `rating` - 评分
- `review_count` - 评价数量
- `service_tags` - 服务标签（JSON）
- `tab_contents` - 标签页内容（JSON）

#### 4. **product_images** - 产品图库表
- `id` - 主键
- `product_id` - 产品ID（外键）
- `image_data` - 图片数据（二进制）
- `filename` - 文件名
- `mimetype` - MIME类型
- `order` - 排序
- `created_at` - 创建时间

#### 5. **contacts** - 联系表单表
- `id` - 主键
- `name` - 姓名
- `email` - 邮箱
- `phone` - 电话
- `message` - 消息内容
- `is_read` - 是否已读
- `created_at` - 创建时间

---

## 🔧 技术栈

### 后端
- **Flask 2.1.3** - Web 框架
- **Flask-SQLAlchemy 3.0.3** - ORM 数据库操作
- **Flask-Login 0.6.3** - 用户认证
- **Flask-WTF 1.2.1** - 表单处理和 CSRF 保护
- **PostgreSQL** - 关系型数据库
- **psycopg2-binary 2.9.9** - PostgreSQL 驱动

### 前端
- **Tailwind CSS** - 实用优先的 CSS 框架（CDN）
- **Font Awesome 4.7.0** - 图标库（CDN）
- **JavaScript (原生)** - 前端交互逻辑

### 开发工具
- **python-dotenv 1.0.0** - 环境变量管理
- **Pillow 10.1.0** - 图片处理

---

## 📝 主要功能

### 前台功能

1. **首页**
   - 英雄区展示
   - 关于我们介绍
   - 核心业务展示
   - 产品中心预览
   - 联系我们表单

2. **产品中心**
   - 产品列表（支持分页）
   - 分类筛选
   - 产品搜索
   - 产品详情页（包含主图和图库图片）

3. **联系我们**
   - 联系表单提交
   - 公司信息展示
   - 常见问题（FAQ）

4. **关于我们**
   - 重定向到首页的关于我们部分

### 后台功能

1. **仪表盘**
   - 数据统计（产品数量、分类数量、未读消息）
   - 最近产品列表
   - 最近未读消息

2. **产品管理**
   - 产品列表（支持搜索、分类筛选、状态筛选）
   - 添加产品（支持主图上传）
   - 编辑产品（支持修改所有字段）
   - 产品图库管理（支持多图上传）
   - 产品上架/下架
   - 删除产品

3. **分类管理**
   - 分类列表
   - 添加分类
   - 编辑分类
   - 删除分类

4. **联系表单管理**
   - 联系表单列表
   - 查看详情
   - 标记已读/未读
   - 删除消息

---

## 🔐 安全特性

1. **CSRF 保护**：所有表单都包含 CSRF token
2. **密码哈希**：使用 Werkzeug 的密码哈希功能
3. **登录认证**：基于 Flask-Login 的会话管理
4. **权限控制**：后台路由使用 `@admin_required` 装饰器保护
5. **文件上传限制**：最大文件大小 5MB

---

## 🐛 常见问题

### 问题1：数据库连接失败

**错误信息**：`psycopg2.OperationalError: could not connect to server`

**解决方法**：
1. 确保 PostgreSQL 服务已启动
2. 检查 `config.py` 中的数据库连接信息
3. 确认数据库 `chunmpre_db` 已创建
4. 检查用户名和密码是否正确

### 问题2：flask 命令不可用

**解决方法**：
```bash
# 使用 python -m flask 代替 flask
python -m flask init-db
python -m flask create-admin
python -m flask run
```

### 问题3：端口被占用

**错误信息**：`Address already in use`

**解决方法**：
```bash
# 使用其他端口
flask run --port=5001
# 或修改 app.py 中的端口号
```

### 问题4：图片上传失败

**解决方法**：
1. 检查文件大小是否超过 5MB
2. 确认文件格式为 JPG、JPEG 或 PNG
3. 检查数据库连接是否正常
4. 查看控制台错误信息

---

## 🚀 生产环境部署

### 1. 环境配置

创建 `.env` 文件：

```env
FLASK_CONFIG=production
SECRET_KEY=your-very-secret-key-here
DATABASE_URL=postgresql://user:password@host:port/dbname
```

### 2. 使用 Gunicorn

```bash
# 安装 Gunicorn
pip install gunicorn

# 启动应用
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

### 3. 使用 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 4. 安全建议

- ✅ 设置强密码的 `SECRET_KEY`
- ✅ 使用 HTTPS
- ✅ 定期备份数据库
- ✅ 限制文件上传大小和类型
- ✅ 启用 CSRF 保护（已在代码中启用）
- ✅ 定期更新依赖包

---

## 📦 依赖包说明

### 核心依赖

- `Flask==2.1.3` - Web 框架
- `Flask-SQLAlchemy==3.0.3` - ORM
- `Flask-Login==0.6.3` - 用户认证
- `Flask-WTF==1.2.1` - 表单处理
- `psycopg2-binary==2.9.9` - PostgreSQL 驱动
- `python-dotenv==1.0.0` - 环境变量管理

### 其他依赖

- `Pillow==10.1.0` - 图片处理
- `Werkzeug==2.1.2` - WSGI 工具库
- `Jinja2==3.1.2` - 模板引擎
- `WTForms==3.0.1` - 表单库

---

## 🗑️ 不必要的文件和代码

### 已废弃的文件

1. **`app/templates/frontend/about.html`**
   - **状态**：已废弃
   - **原因**：关于我们页面已改为重定向到首页的 `#about` 部分
   - **建议**：可以删除，但保留也无影响（不会被使用）

2. **`启动指南.md`**
   - **状态**：已整合
   - **原因**：内容已整合到本文档
   - **建议**：可以删除，或保留作为备份

### 参考文件（不影响运行）

以下文件仅作为设计参考，不影响系统运行：

- `HTML-code/` - 参考 HTML 设计文件
- `chunmpre-admin/` - 参考后台设计文件

### 不应提交到版本控制的文件

- `venv/` - Python 虚拟环境
- `__pycache__/` - Python 缓存文件
- `*.pyc` - Python 编译文件
- `.env` - 环境变量文件（包含敏感信息）

建议创建 `.gitignore` 文件：

```gitignore
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/

# Flask
instance/
.webassets-cache

# 环境变量
.env
.env.local

# IDE
.vscode/
.idea/
*.swp
*.swo

# 系统文件
.DS_Store
Thumbs.db
```

---

## 📊 项目统计

- **Python 文件**：7 个核心文件
- **模板文件**：19 个 HTML 模板
- **数据模型**：5 个（User, Category, Product, ProductImage, Contact）
- **路由蓝图**：3 个（main, admin, auth）
- **表单类**：5 个（LoginForm, CategoryForm, ProductForm, ProductEditForm, ProductImageForm）

---

## 🔄 数据库迁移

### 已执行的迁移

1. **添加产品新字段**（通过 `migrate_add_product_fields.py`）
   - 执行时间：项目开发过程中
   - 影响：为产品表添加了 10 个新字段，支持更丰富的产品信息展示
cd /test/chunmpre.cn && python migrate_add_product_fields.py

### 未来可能的迁移

如果需要添加新功能，建议使用 Flask-Migrate：

```bash
# 安装 Flask-Migrate
pip install Flask-Migrate

# 初始化迁移
flask db init

# 创建迁移
flask db migrate -m "描述信息"

# 执行迁移
flask db upgrade
```

---

## 📞 技术支持

如有问题，请检查：

1. ✅ Python 版本是否符合要求（3.7+）
2. ✅ 所有依赖是否已正确安装
3. ✅ 数据库服务是否正常运行
4. ✅ 端口是否被占用
5. ✅ 数据库连接信息是否正确
6. ✅ 是否已执行数据库迁移脚本

---

## 📄 许可证

本项目为内部使用项目。

---

## 📅 更新日志

### v1.0.0 (当前版本)

- ✅ 完成前后台基础功能
- ✅ 实现产品管理（增删改查）
- ✅ 实现分类管理
- ✅ 实现联系表单管理
- ✅ 完成前台页面设计（Tailwind CSS）
- ✅ 完成后台页面设计（Tailwind CSS）
- ✅ 添加产品新字段支持
- ✅ 实现图片数据库存储
- ✅ 实现产品图库功能
- ✅ 实现分页功能
- ✅ 优化按钮样式和用户体验

---

**文档最后更新**：2024年

**维护者**：开发团队

