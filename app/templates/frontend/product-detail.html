{% extends "frontend/base.html" %}

{% block title %}{{ product.name }} - 东莞春鸣精密机械有限公司{% endblock %}

{% block extra_css %}
<style type="text/tailwindcss">
    @layer utilities {
        .product-image-thumb {
            @apply w-20 h-20 object-cover cursor-pointer border-2 border-transparent hover:border-accent transition-colors rounded;
        }
        .product-image-thumb.active {
            @apply border-accent;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- 面包屑导航 -->
    <section class="pt-24 pb-4 bg-white">
        <div class="container mx-auto px-4 md:px-8">
            <div class="text-sm text-gray-500">
                <a href="{{ url_for('main.index') }}" class="hover:text-primary">首页</a> 
                <i class="fa fa-angle-right inline-block mx-2 text-gray-400"></i>
                <a href="{{ url_for('main.products') }}" class="hover:text-primary">产品中心</a>
                {% if product.category %}
                <i class="fa fa-angle-right inline-block mx-2 text-gray-400"></i>
                <a href="{{ url_for('main.products', category=product.category.id) }}" class="hover:text-primary">{{ product.category.name }}</a>
                {% endif %}
                <i class="fa fa-angle-right inline-block mx-2 text-gray-400"></i>
                <span class="text-gray-700">{{ product.name }}</span>
            </div>
        </div>
    </section>

    <!-- 产品详情区 -->
    <section class="py-12 bg-light">
        <div class="container mx-auto px-4 md:px-8">
            <div class="flex flex-col lg:flex-row gap-12">
                <!-- 产品图片区 -->
                <div class="lg:w-1/2">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-4">
                        {% if product.main_image %}
                        <img id="mainProductImage" 
                             src="{{ url_for('main.get_product_image', product_id=product.id) }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-auto rounded">
                        {% else %}
                        <img id="mainProductImage" 
                             src="https://via.placeholder.com/800x600?text=产品图片" 
                             alt="{{ product.name }}" 
                             class="w-full h-auto rounded">
                        {% endif %}
                    </div>
                    {% set all_images = [] %}
                    {% if product.main_image %}
                        {% set _ = all_images.append({'type': 'main', 'url': url_for('main.get_product_image', product_id=product.id)}) %}
                    {% endif %}
                    {% if product_images %}
                        {% for image in product_images %}
                            {% set _ = all_images.append({'type': 'gallery', 'url': url_for('main.get_gallery_image', image_id=image.id)}) %}
                        {% endfor %}
                    {% endif %}
                    {% if all_images|length > 0 %}
                    <div class="grid grid-cols-4 gap-4">
                        {% for img in all_images %}
                        <img src="{{ img.url }}" 
                             alt="{{ product.name }} 图片{{ loop.index }}" 
                             class="product-image-thumb cursor-pointer border-2 {% if loop.first %}active border-primary{% else %}border-transparent hover:border-gray-300{% endif %} rounded transition-all" 
                             onclick="changeMainImage(this, '{{ img.url }}')">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- 产品信息区 -->
                <div class="lg:w-1/2">
                    {% if product.category %}
                    <span class="inline-block bg-primary/10 text-primary px-3 py-1 rounded-full text-sm mb-3">{{ product.category.name }}</span>
                    {% endif %}
                    <h1 class="text-3xl md:text-4xl font-bold text-primary mb-6">{{ product.name }}</h1>
                    
                    {% if product.rating %}
                    <div class="flex items-center gap-2 mb-6">
                        <div class="flex">
                            {% for i in range(5) %}
                                {% if i < product.rating|int %}
                                    <i class="fa fa-star text-yellow-400"></i>
                                {% else %}
                                    <i class="fa fa-star-o text-gray-300"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if product.review_count %}
                        <span class="text-gray-600">({{ product.review_count }}条评价)</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="mb-8">
                        <span class="text-gray-500">参考价格：</span>
                        {% if product.price_min and product.price_max %}
                            <span class="text-2xl font-bold text-primary ml-2">¥ {{ "{:,.0f}".format(product.price_min|float) }} - ¥ {{ "{:,.0f}".format(product.price_max|float) }}</span>
                        {% elif product.price %}
                            <span class="text-2xl font-bold text-primary ml-2">¥ {{ "{:,.0f}".format(product.price|float) }}</span>
                        {% else %}
                            <span class="text-2xl font-bold text-primary ml-2">面议</span>
                        {% endif %}
                        {% if product.price_note %}
                        <span class="text-gray-500 ml-2">（{{ product.price_note }}）</span>
                        {% endif %}
                    </div>
                    
                    <div class="border-t border-b border-gray-200 py-6 mb-6">
                        {% if product.description %}
                            {% for para in product.description.split('\n') %}
                                {% if para.strip() %}
                                <p class="text-gray-600 {% if not loop.last %}mb-4{% endif %}">
                                    {{ para.strip() }}
                                </p>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    {% set advantages_list = product.get_advantages_list() %}
                    {% if advantages_list %}
                    <div class="space-y-4 mb-8">
                        {% for advantage in advantages_list %}
                        <div class="flex items-start gap-4">
                            <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary mt-0.5 flex-shrink-0">
                                <i class="fa fa-check text-sm"></i>
                            </div>
                            <span class="text-gray-600">{{ advantage }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="flex flex-wrap gap-4 mb-8">
                        <a href="{{ url_for('main.contact') }}" class="btn-primary">
                            咨询报价
                        </a>
                        <a href="{{ url_for('main.contact') }}" class="btn-outline">
                            预约演示
                        </a>
                    </div>
                    
                    {% set service_tags = product.get_service_tags_list() %}
                    {% if service_tags %}
                    <div class="flex items-center gap-4 text-gray-600 text-sm flex-wrap">
                        {% for tag in service_tags %}
                        <div class="flex items-center gap-2">
                            {% if loop.index0 == 0 %}
                                <i class="fa fa-truck"></i>
                            {% elif loop.index0 == 1 %}
                                <i class="fa fa-shield"></i>
                            {% else %}
                                <i class="fa fa-refresh"></i>
                            {% endif %}
                            <span>{{ tag }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="flex items-center gap-4 text-gray-600 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fa fa-truck"></i>
                            <span>支持全国配送</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-shield"></i>
                            <span>质保服务</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-refresh"></i>
                            <span>终身维护支持</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- 产品详细参数 -->
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4 md:px-8">
            {% set tab_contents = product.get_tab_contents_dict() %}
            {% if tab_contents and tab_contents|length > 0 %}
            <div class="border-b border-gray-200 mb-8">
                <div class="flex flex-wrap">
                    {% for tab_name in tab_contents.keys() %}
                    <button class="px-6 py-4 font-medium {% if loop.first %}text-primary border-b-2 border-primary{% else %}text-gray-500 hover:text-primary{% endif %}" 
                            onclick="showTab('{{ tab_name }}', this)">
                        {{ tab_name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            
            {% for tab_name, tab_content in tab_contents.items() %}
            <div id="tab-{{ tab_name }}" class="tab-content {% if not loop.first %}hidden{% endif %}">
                <div class="prose max-w-none">
                    {% if tab_content and tab_content.strip() %}
                        <div class="text-gray-600 whitespace-pre-line">{{ tab_content }}</div>
                    {% else %}
                        <p class="text-gray-500">暂无内容</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <!-- 默认显示技术规格 -->
            <div class="border-b border-gray-200 mb-8">
                <div class="flex flex-wrap">
                    <button class="px-6 py-4 font-medium text-primary border-b-2 border-primary" onclick="showTab('specs', this)">详细参数</button>
                    <button class="px-6 py-4 font-medium text-gray-500 hover:text-primary" onclick="showTab('description', this)">产品描述</button>
                </div>
            </div>
            
            <div id="tab-specs" class="tab-content">
                {% set tech_specs = product.get_technical_specs_dict() %}
                {% if tech_specs %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                    <div>
                        <h3 class="text-xl font-bold text-primary mb-4">基本参数</h3>
                        <table class="w-full">
                            <tbody>
                                {% for key, value in tech_specs.items() %}
                                <tr class="border-b border-gray-100">
                                    <td class="py-3 text-gray-600">{{ key }}</td>
                                    <td class="py-3 font-medium">{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% elif product.specifications %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                    <div>
                        <h3 class="text-xl font-bold text-primary mb-4">基本参数</h3>
                        <table class="w-full">
                            <tbody>
                                {% for param in product.specifications.split('\n') %}
                                    {% if param.strip() and ':' in param %}
                                        {% set parts = param.split(':', 1) %}
                                        <tr class="border-b border-gray-100">
                                            <td class="py-3 text-gray-600">{{ parts[0].strip() }}</td>
                                            <td class="py-3 font-medium">{{ parts[1].strip() }}</td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <p class="text-gray-600">暂无技术规格信息</p>
                {% endif %}
            </div>
            
            <div id="tab-description" class="tab-content hidden">
                <div class="prose max-w-none">
                    <p class="text-gray-600 whitespace-pre-line">{{ product.description }}</p>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <!-- 相关产品 -->
    {% if related_products %}
    <section class="py-16 bg-light">
        <div class="container mx-auto px-4 md:px-8">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-primary mb-4">相关产品</h2>
                <div class="w-20 h-1 bg-accent mx-auto mb-6"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                {% for related in related_products %}
                <div class="bg-white rounded-lg overflow-hidden shadow-md card-hover cursor-pointer" 
                     onclick="window.location='{{ url_for('main.product_detail', product_id=related.id) }}'">
                    <div class="h-48 overflow-hidden">
                        {% if related.main_image %}
                        <img src="{{ url_for('main.get_product_image', product_id=related.id) }}" 
                             alt="{{ related.name }}" 
                             class="w-full h-full object-cover transition-transform duration-500 hover:scale-110">
                        {% else %}
                        <img src="https://via.placeholder.com/400x300?text=产品图片" 
                             alt="{{ related.name }}" 
                             class="w-full h-full object-cover transition-transform duration-500 hover:scale-110">
                        {% endif %}
                    </div>
                    <div class="p-6">
                        <h3 class="text-lg font-bold text-primary mb-2">{{ related.name }}</h3>
                        <p class="text-gray-600 mb-4 text-sm" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ related.description }}
                        </p>
                        <p class="text-primary font-bold mb-2">
                            {% if related.price_min and related.price_max %}
                                ¥ {{ "{:,.0f}".format(related.price_min|float) }} - ¥ {{ "{:,.0f}".format(related.price_max|float) }}
                            {% elif related.price %}
                                ¥ {{ "{:,.0f}".format(related.price|float) }}
                            {% else %}
                                面议
                            {% endif %}
                        </p>
                        <a href="{{ url_for('main.product_detail', product_id=related.id) }}" 
                           class="text-accent hover:underline flex items-center gap-2 text-sm">
                            查看详情 <i class="fa fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // 切换主图
    function changeMainImage(thumb, imageUrl) {
        const mainImage = document.getElementById('mainProductImage');
        if (mainImage && imageUrl) {
            mainImage.src = imageUrl;
        }
        // 更新缩略图活跃状态
        document.querySelectorAll('.product-image-thumb').forEach(img => {
            img.classList.remove('active');
        });
        thumb.classList.add('active');
    }
    
    // 切换标签页
    function showTab(tabName, buttonElement) {
        // 隐藏所有标签内容
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });
        // 重置所有标签按钮样式
        const tabButtons = document.querySelectorAll('button[onclick^="showTab"]');
        tabButtons.forEach(btn => {
            btn.classList.remove('text-primary', 'border-b-2', 'border-primary');
            btn.classList.add('text-gray-500');
        });
        // 显示选中的标签内容
        const selectedTab = document.getElementById('tab-' + tabName);
        if (selectedTab) {
            selectedTab.classList.remove('hidden');
        }
        // 更新按钮样式
        if (buttonElement) {
            buttonElement.classList.remove('text-gray-500');
            buttonElement.classList.add('text-primary', 'border-b-2', 'border-primary');
        }
    }
</script>
{% endblock %}
