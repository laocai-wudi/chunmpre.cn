{% extends "admin/base.html" %}

{% block title %}编辑产品{% endblock %}

{% block content %}
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-primary">编辑产品</h1>
                <p class="text-gray-500 text-sm mt-1">修改产品信息</p>
            </div>
            <a href="{{ url_for('admin.manage_products') }}" class="btn-outline">
                <i class="fa fa-arrow-left mr-2"></i>返回列表
            </a>
        </div>
    </div>

    <!-- 产品表单 -->
    <form method="POST" enctype="multipart/form-data">
        {% if config.WTF_CSRF_ENABLED %}
        {{ form.hidden_tag() }}
        {% endif %}
        
        <!-- 基本信息 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">基本信息</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.name.label.text }} <span class="text-red-500">*</span></label>
                    {% if form.name.errors %}
                        {{ form.name(class="w-full px-4 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500") }}
                        <p class="mt-1 text-sm text-red-600">{{ form.name.errors[0] }}</p>
                    {% else %}
                        {{ form.name(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.brand.label.text }}</label>
                    {{ form.brand(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.category_id.label.text }} <span class="text-red-500">*</span></label>
                    {{ form.category_id(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                    <div class="flex items-center mt-2">
                        {{ form.status(class="w-4 h-4 text-primary border-gray-300 rounded") }}
                        <label class="ml-2 text-sm text-gray-700">上架产品</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 价格信息 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">价格信息</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.price.label.text }}</label>
                    {{ form.price(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                    <p class="mt-1 text-xs text-gray-500">单一价格（可选）</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.price_min.label.text }}</label>
                    {{ form.price_min(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.price_max.label.text }}</label>
                    {{ form.price_max(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.price_note.label.text }}</label>
                    {{ form.price_note(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                    <p class="mt-1 text-xs text-gray-500">如：根据型号配置</p>
                </div>
            </div>
        </div>

        <!-- 产品描述 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">产品描述</h3>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.description.label.text }}</label>
                {{ form.description(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="5") }}
            </div>
        </div>

        <!-- 产品优势 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">产品优势</h3>
                <p class="text-xs text-gray-500">每行一个优势，将显示为带勾号的列表</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.advantages.label.text }}</label>
                {{ form.advantages(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="6") }}
            </div>
        </div>

        <!-- 技术规格 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">技术规格</h3>
                <p class="text-xs text-gray-500">JSON格式：{"品牌": "Taylor Hobson", "型号": "xxx", ...}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.technical_specs.label.text }}</label>
                {{ form.technical_specs(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono text-sm", rows="6") }}
            </div>
        </div>

        <!-- 服务标签 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">服务标签</h3>
                <p class="text-xs text-gray-500">每行一个标签</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.service_tags.label.text }}</label>
                {{ form.service_tags(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="3") }}
            </div>
        </div>

        <!-- 评分和评价 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">评分和评价</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.rating.label.text }}</label>
                    {{ form.rating(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.review_count.label.text }}</label>
                    {{ form.review_count(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
            </div>
        </div>

        <!-- 标签页内容 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">标签页内容</h3>
                <p class="text-xs text-gray-500">JSON格式：{"详细参数": "内容", "应用案例": "内容", "技术文档": "内容", "用户评价": "内容"}</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ form.tab_contents.label.text }}</label>
                {{ form.tab_contents(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 font-mono text-sm", rows="8") }}
            </div>
        </div>

        <!-- 其他字段（保留兼容） -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">其他信息（兼容旧数据）</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">库存</label>
                    {{ form.stock(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">规格参数（旧格式）</label>
                    {{ form.specifications(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="4") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">产品特点（旧格式）</label>
                    {{ form.features(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="4") }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">应用场景</label>
                    {{ form.applications(class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50", rows="3") }}
                </div>
            </div>
        </div>

        <!-- 产品图片 -->
        <div class="card mb-6">
            <div class="mb-4">
                <h3 class="font-bold text-lg">产品主图</h3>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center" id="image-preview">
                {% if product.main_image %}
                    <img id="preview-img" src="{{ url_for('main.get_product_image', product_id=product.id) }}" 
                         class="w-full h-48 object-cover rounded mb-3 mx-auto">
                {% else %}
                    <img id="preview-img" src="https://via.placeholder.com/400x300?text=产品图片" 
                         class="w-full h-48 object-cover rounded mb-3 mx-auto">
                {% endif %}
                <p class="text-sm text-gray-500 mb-2">点击上传或拖放图片（不选择将保持现有图片）</p>
                {{ form.main_image(class="hidden", id="main-image-input") }}
                <button type="button" class="btn-primary text-sm" id="upload-btn">
                    <i class="fa fa-upload mr-1"></i>选择图片
                </button>
                {% if product.main_image %}
                <button type="button" class="ml-2 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" id="remove-image-btn">
                    <i class="fa fa-trash mr-1"></i>移除图片
                </button>
                {% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">支持格式: JPG, JPEG, PNG. 最大文件大小: 5MB</p>
        </div>

        <!-- 提交按钮 -->
        <div class="flex justify-end gap-3">
            <a href="{{ url_for('admin.manage_products') }}" class="btn-outline">取消</a>
            <button type="submit" class="btn-primary">
                <i class="fa fa-save mr-2"></i>保存修改
            </button>
        </div>
    </form>

    <!-- 产品图库管理链接 -->
    <div class="card mt-6">
        <div class="mb-4">
            <h3 class="font-bold text-lg">产品图库</h3>
        </div>
        <p class="text-gray-600 mb-4">产品图库包含产品的多张展示图片，可以从多个角度展示产品特性。</p>
        <a href="{{ url_for('admin.manage_product_images', product_id=product.id) }}" class="btn-outline inline-block">
            <i class="fa fa-images mr-2"></i>管理产品图库
        </a>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const imageInput = document.getElementById('main-image-input');
        const previewImg = document.getElementById('preview-img');
        const uploadBtn = document.getElementById('upload-btn');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const imagePreview = document.getElementById('image-preview');
        
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                imageInput.click();
            });
        }
        
        if (imageInput) {
            imageInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        }
        
        if (removeImageBtn) {
            removeImageBtn.addEventListener('click', function() {
                if (confirm('确定要移除当前图片吗？')) {
                    let removeInput = document.getElementById('remove_image');
                    if (!removeInput) {
                        removeInput = document.createElement('input');
                        removeInput.type = 'hidden';
                        removeInput.name = 'remove_image';
                        removeInput.id = 'remove_image';
                        removeInput.value = 'true';
                        imageInput.parentNode.appendChild(removeInput);
                    }
                    previewImg.src = 'https://via.placeholder.com/400x300?text=产品图片';
                    removeImageBtn.disabled = true;
                    removeImageBtn.classList.add('opacity-50');
                    imageInput.value = '';
                }
            });
        }
        
        if (imagePreview) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imagePreview.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                imagePreview.addEventListener(eventName, function() {
                    imagePreview.classList.add('border-primary', 'bg-primary/5');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                imagePreview.addEventListener(eventName, function() {
                    imagePreview.classList.remove('border-primary', 'bg-primary/5');
                }, false);
            });
            
            imagePreview.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    imageInput.files = files;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                    };
                    reader.readAsDataURL(files[0]);
                }
            }, false);
        }
    });
</script>
{% endblock %}
